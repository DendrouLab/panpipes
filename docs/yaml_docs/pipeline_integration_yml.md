<style>
  .parameter {
    border-top: 4px solid lightblue;
    background-color: rgba(173, 216, 230, 0.2);
    padding: 4px;
    display: inline-block;
    font-weight: bold;
  }
</style>
 
# Integration YAML 

This documentation explains the parameters of the `integration` configuration yaml file generated by running the `panpipes integration config`.<br> The steps to run the pipeline are described in the [integration workflow](docs/workflows/integration.md). 

When running the integration workflow, panpipes provides you with a basic `pipeline.yml` file. To run the workflow with your own data you need to specify the parameters described below in the `pipeline.yml` file to meet the requirements of your data. However, we do provide pre-filled versions of the `pipeline.yml` for individual [tutorials](https://panpipes-pipelines.readthedocs.io/en/latest/tutorials/index.html).

You can download the different integration pipeline.yml files here:
- Basic `pipeline.yml` file (not pre-filled) that is generated when calling `panpipes integration config`: [Download here](https://github.com/DendrouLab/panpipes/blob/main/panpipes/panpipes/pipeline_integration/pipeline.yml)
- `pipeline.yml`for Integration tutorial: [View and Download here](https://panpipes-tutorials.readthedocs.io/en/latest/uni_multi_integration/pipeline_yml.html)

For more information on functionalities implemented in `panpipes` to read the configuration files, such as reading blocks of parameters and reusing blocks with  `&anchors` and `*scalars`, please check [our documentation](./useful_info_on_yml.md)

## Compute resources options

<span class="parameter">resources</span><br>
Computing resources to use, specifically the number of threads used for parallel jobs.
Specified by the following parameters:
  - <span class="parameter">threads_high</span> `Integer`, Default: 1<br>
   Number of threads used for high intensity computing tasks. 
   For each thread, there must be enough memory to load your MuData object which was created in the preprocessing step of 
   the workflow.
       
  - <span class="parameter">threads_medium</span> `Integer`, Default: 1<br>
   Number of threads used for medium intensity computing tasks.
   For each thread, there must be enough memory to load your mudata and do computationally light tasks.

  - <span class="parameter">threads_low</span> `Integer`, Default: 1<br>
   Number of threads used for low intensity computing tasks.
   For each thread, there must be enough memory to load text files and do plotting, requires much less memory than the other two.  
  - <span class="parameter">threads_gpu</span> `Integer`, Default: 2<br>
   Number of cores per gpu used for computing tasks.
   For each thread, there must be enough memory to compute the tasks above. 

<span class="parameter">condaenv</span> `String`<br>
  Path to conda environment that should be used to run panpipes.
  Leave blank if running native or your cluster automatically inherits the login node environment

<span class="parameter">queues</span><br>
Allows for tweaking which queues jobs get submitted to, in case there is a special queue for long jobs, or you have access to a gpu-specific queue.
The default queue should be specified in your .cgat.yml file.
Leave blank if you do not want to use any alternative queues.
  - <span class="parameter">long</span><br>
  - <span class="parameter">gpu</span><br>

## Loading and merging data options
### Data format

<span class="parameter">sample_prefix</span> `String`, Mandatory parameter, Default: test<br>
Prefix for the sample that comes out of the filtering/ preprocessing steps of the workflow.

<span class="parameter">preprocessed_obj</span> `String`, Mandatory parameter<br>
 Path to the output file from preprocessing (e.g. `../preprocess/test.h5mu`).
 Ensure that the submission file is in the right format and that the correct path is provided.

## Batch correction

**Batch correction is done in unimodal mode, meaning each modality is batch corrected independently.**

### RNA modality

<span class="parameter">rna:</span> 
  Batch correction for the RNA modality is specified by the following parameters:
  
    
  - <span class="parameter">run</span> `Boolean`, Default: True<br>
    Defines if you want the batch correction to run. If set to `False`, `PCA` with default parameters is calculated. 
        
  - <span class="parameter">tools</span> `String` (comma-separated), Default: `harmony,bbknn,scanorama,scvi`<br> 
    Defines the method used to run batch correction, multiple can be selected and run simultaneously.

    Choices: `harmony`, `bbknn`, `scanorama`, `scvi`
       
   - <span class="parameter">column</span> `String` (comma-separated), Default: sample_id<br>

     The column name of the covariate you want want to batch correct on, if a comma-separated list is specified then all will be used simultaneously.
 
#### Harmony arguments
  
- <span class="parameter">harmony:</span>
    Basic parameters required to run harmony:
   
    - <span class="parameter">sigma</span> `Float`, Default: 0.1<br>
    - <span class="parameter">theta</span> `Float`, Default: 1.0<br>
    - <span class="parameter">npcs</span> `Integer`, Default: 30<br>

  For more information on `harmony` check the [harmony documentation](https://portals.broadinstitute.org/harmony/reference/RunHarmony.html)

#### BBKNN arguments

- <span class="parameter">bbknn:</span>  
  - <span class="parameter">neighbors_within_batch:</span> `Integer`, Default: 3<br>

For more information on `bbknn` check the [bbknn documentation](https://bbknn.readthedocs.io/en/latest/) 

#### SCVI arguments
  -  <span class="parameter">scvi</span>: SCVI parameters are specified as
      - <span  class="parameter">exclude_mt_genes:</span> `Boolean`, Default: True<br>
      - <span  class="parameter">exclude_mt_genes:</span> `String`, Default: mt<br>
      - <span class="parameter">model_args:</span>
    Model argument parameters:
         - <span class="parameter">n_layers:</span> `Float`, Default: 1.0<br>
      
         - <span class="parameter">n_latent:</span> `Integer`, Default: 10<br>
      
         - <span class="parameter">gene_likelihood:</span> `String`, Default: zinb<br>
    
     -  <span class="parameter">training_agrs</span>
    Training argument parameters:
         - <span class="parameter">max_epochs</span> `Integer`, Default: 400<br>
         
         - <span class="parameter">train_size</span> `Float`, Default: 0.9<br>
         
         - <span class="parameter">early_stopping:</span> `Boolean`, Default: True<br>
    
     -  <span class="parameter">training_plan</span>
    Training plan parameters:
         - <span class="parameter">lr</span> `Float`, Default:0.001<br>
         
         - <span class="parameter">n_epochs_kl_warmup:</span> `Integer`, Default: 40<br>
         
         - <span class="parameter">reduce_lr_on_plateau:</span> `Boolean`, Default: True<br>
  
         - <span class="parameter">lr_scheduler_metric</span><br> `String`, Default: elbo_validation<br>
    
         - <span class="parameter">lr_patience</span> `Integer`, Default: 8<br>
         
         - <span class="parameter">lr_factor</span> `Float`, Default: 0.1<br>
         
  For more information on `scvi` check the [scvi documentation](https://docs.scvi-tools.org/en/stable/api/reference/scvi.model.SCVI.html)

#### KNN calculation on RNA modality
Parameters to compute the connectivity graph on RNA

- <span class="parameter">neighbors:</span> `String`<br>
 
  - <span class="parameter">npcs</span> `Integer`, Default: 30<br>   
   Number of principal components to calculate for neighbors and Umap
  
  -  <span class="parameter">k</span> `Integer`, Default: 30<br>
  Number of neighbors
  
  -  <span class="parameter">metric</span> `String`, Default: euclidean<br>
   Metric can be either euclidean or cosine
  
  -  <span class="parameter">method</span> `String`, Default: scanpy<br>
    The method can either be scanpy or hnsw


### Protein modality
<span class="parameter">prot:</span> 
  Batch correction for the protein modality is specified by the following parameters:
  
    
  - <span class="parameter">run</span> `Boolean`, Default: True<br>
    Defines if you want the batch correction to run on the Protein modality.If set to `False`, `PCA` with default parameters is calculated. 
        
  - <span class="parameter">tools</span> `String` (comma-separated), Default: harmony<br> 
    Defines the method used to run batch correction, multiple can be selected.
    choices: harmony, bbknn, combat
       
   - <span class="parameter">column</span> `String` (comma-separated), Default: sample_id<br>

     The column you want to batch correct on, if a comma-separated list is specified then all will be used simultaneously
 
#### Harmony arguments
  
<span class="parameter">harmony</span><br>
Basic parameters required to run harmony:

- <span class="parameter">sigma</span> `Float`, Default: 0.1<br>
- <span class="parameter">theta</span> `Float`, Default: 1.0<br>
- <span class="parameter">npcs</span> `Integer`, Default: 30<br>

For more information on `harmony` check the [harmony documentation](https://portals.broadinstitute.org/harmony/reference/RunHarmony.html)

  
#### BBKNN arguments

<span class="parameter">bbknn</span><br> 
  - <span class="parameter">neighbors_within_batch:</span> `Integer`, Default: 3<br>

For more information on `bbknn` check the [bbknn documentation](https://bbknn.readthedocs.io/en/latest/) 

#### KNN calculation on Protein modality

Parameters to compute the connectivity graph on Protein

<span class="parameter">neighbors</span> `String`, Default: &prot_neighbors<br>
 
  - <span class="parameter">npcs</span> `Integer`, Default: 30<br>
    Number of principal components to calculate for neighbors and Umap
  
  -  <span class="parameter">k</span> `Integer`, Default: 30<br>
  Number of neighbors
  
  -  <span class="parameter">metric</span> `String`, Default: euclidean<br>
   Metric can be either euclidean or cosine
  
  -  <span class="parameter">methof</span> `String`, Default: scanpy<br>
    The method can either be scanpy or hnsw


### ATAC modality 

<span class="parameter">atac:</span> 
  Batch correction for the ATAC modality is specified by the following parameters:

  - <span class="parameter">run</span> `Boolean`, Default: False<br>
    Defines if you want the batch correction to run. If set to `False`, `PCA` with default parameters is calculated. 
    
  - <span class="parameter">dimred</span> `String`, Default: PCA<br>
    Defines which dimensionality reduction to use. Available options are PCA and LSI.
    
  - <span class="parameter">tools</span> `String` (comma-separated), Default: harmony<br> 
    Defines the method used to run batch correction.
    Multiple can be selected by specifying them as a comma-seprated string without spaces.
    Available options are: harmony, bbknn, and combat
       
   - <span class="parameter">column</span> `String` (comma-separated), Default: sample_id<br>
     The column you want to batch correct on.
     If a comma-separated list is provided then all will be used simultaneously.
 
#### Harmony arguments
  
- <span class="parameter">harmony:</span>
    Basic parameters required to run harmony:
   
    - <span class="parameter">sigma</span> `Float`, Default: 0.1<br>
    - <span class="parameter">theta</span> `Float`, Default: 1.0<br>
    - <span class="parameter">npcs</span> `Integer`, Default: 30<br>

  For more information on `harmony` check the [harmony documentation](https://portals.broadinstitute.org/harmony/reference/RunHarmony.html)

  
#### BBKNN arguments

- <span class="parameter">bbknn:</span>  

  - <span class="parameter">neighbors_within_batch:</span> `Integer`, Default: 3<br>

For more information on `bbknn` check the [bbknn documentation](https://bbknn.readthedocs.io/en/latest/).
  

#### KNN calculation on ATAC modality

- <span class="parameter">neighbors:</span> `String` <br>
 
  - <span class="parameter">npcs</span> `Integer`, Default: 30<br>   
   Number of principal components to calculate for neighbors and UMAP.
  
  -  <span class="parameter">k</span> `Integer`, Default: 30<br>
  Number of neighbors
  
  -  <span class="parameter">metric</span> `String`, Default: euclidean<br>
   Metric can be either euclidean or cosine
  
  -  <span class="parameter">method</span> `String`, Default: scanpy<br>
    The method can either be scanpy or hnsw


## Multimodal integration             
<span class="parameter">multimodal:</span> 

 - <span class="parameter">run</span> `Boolean`, Default: True<br>
 Set to False if you don't want to run multimodal integration 

 - <span class="parameter">tools</span> `String`(Comma separated), Default: "WNN"<br>
 Method you want to use to run batch correction. Options include: WNN, totalvi and multiVI. You can specify mutiple methods and they will be run simultaneously. 

 - <span class="parameter">column_categorical</span> `String`(Comma separated), Default: sample_id<br>
 This is the column you want to run a batch correction on.
 Mltiple columns can be selected simultaneously by providing them as a comma-separated string without spaces.

 Extra parameters: 
 
### TotalVI arguments

  **TotalVI has to run on both rna and protein data**
  
   This is the minimal set of TotalVI parameters required, you can add more if it fits your analysis better. 

 
 - <span class="parameter">totalvi:</span> 

   -  <span class="parameter">modalities</span> `String`(Comma separated), Default: rna,prot<br>
   -  <span class="parameter">exclude_mt_genes</span> `Boolean`, Default: True<br>
   -  <span class="parameter">mt_column</span> `String`, Default: mt<br>
   -  <span class="parameter">filter_by_hvg</span> `Boolean`, Default: True<br>
      To filter manually create a column called prot_outliers in mdata['prot']
   
   -  <span class="parameter">filter_prot_outliers</span> `Boolean`, Default: False<br>
   -  <span class="parameter">model_args</span>:
      -  <span class="parameter">latent_distribution</span>`String`, Default: "normal"<br>
      
   -  <span class="parameter">training_args</span>:
      -  <span class="parameter">max_epochs</span>`Integer`, Default: 100<br>
      -  <span class="parameter">train_size</span>`Float`, Default: 0.9<br>
      -  <span class="parameter">early_stopping</span> `Boolean`, Default: True<br>
   -  <span class="parameter">training_plan</span> `String`, Default: None<br>

### MultiVI arguments

  **MultiVI has to run on both rna and atac data**

   This is the minimal set of MultiVI parameters required, you can add more if it fits your analysis better. 
   
   Setting `lowmem` to True it will subset the ATAC data to the top 25k HVF which is recommended to deal with the concatenation of atac and rna on large datasets which at the moment is required by `scvi-tools`.
   Note that >100GB of RAM are required to concatenate ATAC and RNA data with 15k cells and 120k total features (union rna,atac)

 -  <span class="parameter">MultiVI:</span>
  
    - <span class="parameter">lowmen</span> `Boolean`, Default: True<br>
    -  <span class="parameter">model_args</span> `String`, Default: None<br>
        -  <span class="parameter">n_hidden</span> `String`, Default: None<br>
        -  <span class="parameter">n_latent</span> `Boolean`, Default: True<br>
        -  <span class="parameter">region_factors</span> `Boolean`, Default: True<br>
        -  <span class="parameter">latent_distribution</span> `String`, Default: normal<br>
        -  <span class="parameter">deeply_inject_covariates</span> `Boolean`, Default: False<br>
        -  <span class="parameter">fully_paired</span> `Boolean`, Default: False<br>
    -  <span class="parameter">training_args</span> 
        -  <span class="parameter">max_epochs</span> `Integer`, Default: 500<br>
        -  <span class="parameter">lr</span> `Float`, Default: 0.0001<br>
        -  <span class="parameter">use_gpu</span> `String`, Default: None<br>
           Leave blank for default str, int and bool.
        -  <span class="parameter">train_size</span> `Float`, Default: 0.9<br>
        -  <span class="parameter">validation_size</span> `String`, Default: None<br>
           Leave blank for default
        -  <span class="parameter">batch_size</span> `Integer`, Default: 128<br>
        -  <span class="parameter">weight_decay</span> `Float`, Default: 0.001<br>
        -  <span class="parameter">eps</span> `Float`, Default: 1e-08<br>
        -  <span class="parameter">early_stopping</span> `Boolean`, Default: True<br>
        -  <span class="parameter">save_best</span> `Boolean`, Default: True<br>
        -  <span class="parameter">check_val_every_n_epoch</span> `String`, Default: None<br>
           Leave blank for the default integer
        -  <span class="parameter">n_steps_kl_warmup</span> `String`, Default: None<br>
           Leave blank for the default integer
        -  <span class="parameter">n_epochs_kl_warmup</span> `Integer`, Default: 50<br>
        -  <span class="parameter">adversarial_mixing</span> `Boolean`, Default: True<br>
  -  <span class="parameter">training_plan</span> `String`, Default: None<br>
  
  
### Mofa arguments

**Requires at least two modalities, can run with three**
  
  This is the minimal set of Mofa parameters required, you can add more if it fits your analysis better. 

-  <span class="parameter">mofa:</span> 
   -  <span class="parameter">modalities</span> `String` (Comma separated), Default: rna,prot,atac<br>
   -  <span class="parameter">fliter_by_hgv</span> `Boolean`, Default: True<br>
   -  <span class="parameter">n_factors</span> `Integer`, Default: 10<br>
   -  <span class="parameter">n_iterations</span> `Integer`, Default: 1000<br>
   -  <span class="parameter">convergence_mode</span> `String`, Default: fast<br>
      Choice between fast, medium, and slow
   -  <span class="parameter">save_parameters</span> `Boolean`, Default: False<br>
   -  <span class="parameter">outfile</span> `String`, Default: `path/to/h5ad/to_save_model_to`<br> 

### WNN arguments

**Requires at least two modalities, can run with three**

 This is the minimal set of WNN parameters required, you can add more if it fits your analysis better.
 Panpipes uses muon's implementation of WNN. 
 
- <span class="parameter">WNN:</span>
    
  -  <span class="parameter">modalities</span> `String` (Comma separated), Default: rna, prot, atac <br>
  -  <span class="parameter">batch_corrected</span> `String`, Default: None<br>
  
       Set the modality to one method ("bbknn", "scVI", "harmony", "scanorama"), if left None, a default de novo calculation of neighbours on non-corrected data for that modality using specified parameters
     -  <span class="parameter">rna</span> `String`, Default: None<br>
        Options here include "bbknn" and "harmony"

     -  <span class="parameter">prot</span> `String`, Default: None<br>
        Options here include "harmony"

     -  <span class="parameter">atac</span> `String`, Default: None<br>
   
  - <span class="parameter">knn:</span> 
      -  <span class="parameter">rna</span> `String`, Default: *rna_neighbors<br>
      -  <span class="parameter">prot</span> `String`, Default: *prot_neighbors<br>
      -  <span class="parameter">atac</span> `String`, Default: *atac_neighbors<br>

   - <span class="parameter">n_neighbors</span> `String`, Default: "leave blank"<br>
     Leave blank to arithmetic mean across modalities neighbors 

   - <span class="parameter">n_bandwidth_neighbors</span> `Integer`, Default: 20<br>

   - <span class="parameter">n_multineighbors</span> `Integer`, Default: 200<br>

   - <span class="parameter">metric</span> `String`, Default: euclidean<br>

   - <span class="parameter">low_memory</span> `Boolean`, Default: True<br>

### KNN calculation for multimodal analysis
  - <span class="parameter">neighbors:</span> 
      -  <span class="parameter">npcs</span> `Integer`, Default: 30<br>
         The number of principal components to calculate for neighbors and UMAP.
         If no correction is applied PCA will be calculated and used to run the UMAP.
         If harmony is chosen it will use the following components to create a corrected dimensionality reduction.
    
     -  <span class="parameter">k</span> `Integer`, Default: 30<br>
     -  <span class="parameter">metric</span> `String`, Default: euclidean<br>
   Options include euclidean and cosine

     - <span class="parameter">method</span> `String`, Default: scanpy<br>
   Options include scanpy and hnsw


## Plotting parameters 

- <span class="parameter">plotqc:</span> <br>
   -  <span class="parameter">grouping_var</span> `String`, Default: sample_id<br>
      Column name(s) of the covariate(s) you want to group the plot on. Must be a categorical variable.
      Must be provided as a comma-separated String, without spaces.
   
Specify other metrics you want to plot on each modality's embedding. One plot per group will be created.
Use the notation `mod:variable` .
These can be categorical or numeric variables.
Any metrics you may want to plot on all modality UMAPs should be listed under `all`.
   -  <span class="parameter">all</span> `String`, Default: rep:receptor_subtype<br>
   -  <span class="parameter">rna</span> `String`, Default: rna:total_counts<br>
   -  <span class="parameter">prot</span> `String`, Default: prot:total_counts<br>
   -  <span class="parameter">atac</span>  `String`, Default: atac:total_counts<br>
   -  <span class="parameter">multimodal</span> `String`, Default: rna:total_counts<br>

If you want to add any additional plots, simply remove the log file (logs/plot_batch_corrected_umaps.log) and run `panpipes integration make plot_umaps`.

## Creating the final object 

Leave this final option blank until you have reviewed the results from running `panpipes integration make full`. 

This step will produce a `MuData` object with one layer for each modality, and the multimodal embeddings are stored as global view. 
To store the embeddings resulting from batch correction algorithms applied for each modality, set the relevant `include` to `True` and specify which algorithms you want to retain. The embeddings generated from the multimodal runs are stored in the global mudata layer.
To select the uncorrected unimodal embeddings, use "no_correction" for the relevant modalities. 
Setting the `include` parameter to `False` for a specific modality will generate a `Mudata` without that modality.

**Then run**`panpipes integration make merge_integration`

- <span class="parameter">final_obj:</span> 
   -  <span class="parameter">rna:</span>
      -  <span class="parameter">include</span> `Boolean`, Default: True<br>
      -   <span class="parameter">bc_choice</span> `String`, Default: harmony<br>
   - <span class="parameter">prot:</span>
      -  <span class="parameter">include</span> `Boolean`, Default: True<br>
      -  <span class="parameter">bc_choice</span> `String`, Default: harmony<br>
   - <span class="parameter">atac:</span>
      -  <span class="parameter">include</span> `Boolean`, Default: False<br>
      -  <span class="parameter">bc_choice</span> `Boolean`, Default: harmony<br>
     
   - <span class="parameter">multimodal:</span>

      -  <span class="parameter">include</span> `Boolean`, Default: True<br>
      -  <span class="parameter">bc_choice</span> `String`, Default: totalvi<br>
