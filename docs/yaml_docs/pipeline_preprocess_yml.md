<style>
  .parameter {
    border-top: 4px solid lightblue;
    background-color: rgba(173, 216, 230, 0.2);
    padding: 4px;
    display: inline-block;
    font-weight: bold;
  }
</style>

# Preprocess YAML

In this documentation, the parameters of the `preprocess` configuration yaml file are explained. 
This file is generated by running `panpipes preprocess config`.  <br> The individual steps run by the pipeline are described in the [preprocess workflow](../workflows/preprocess.md). 

When running the preprocess workflow, panpipes provides a basic `pipeline.yml` file.
To run the workflow on your own data, you need to specify the parameters described below in the `pipeline.yml` file to meet the requirements of your data.
However, we do provide pre-filled versions of the `pipeline.yml` file for individual [tutorials](https://panpipes-pipelines.readthedocs.io/en/latest/tutorials/index.html).

For more information on functionalities implemented in `panpipes` to read the configuration files, such as reading blocks of parameters and reusing blocks with  `&anchors` and `*scalars`, please check [our documentation](./useful_info_on_yml.md)


You can download the different preprocess `pipeline.yml` files here:
- Basic `pipeline.yml` file (not prefilled) that is generated when calling `panpipes preprocess config: [Download here]

## Compute resources options

<span class="parameter">resources</span><br>
Computing resources to use, specifically the number of threads used for parallel jobs.
Specified by the following three parameters:
  - <span class="parameter">threads_high</span> `Integer`, Default: 2<br>
        Number of threads used for high intensity computing tasks. 
        For each thread, there must be enough memory to load all your input files at once and create the MuData object.

  - <span class="parameter">threads_medium</span> `Integer`, Default: 2<br>
        Number of threads used for medium intensity computing tasks.
        For each thread, there must be enough memory to load your mudata and do computationally light tasks.

  - <span class="parameter">threads_low</span> `Integer`, Default: 1<br>
  	    Number of threads used for low intensity computing tasks.
        For each thread, there must be enough memory to load text files and do plotting, requires much less memory than the other two.

<span class="parameter">condaenv</span> `String` (Path)<br>
    Path to conda environment that should be used to run panpipes.
    Leave blank if running native or your cluster automatically inherits the login node environment.

## General project specifications

<span class="parameter">sample_prefix</span> `String`<br>
    Prefix for sample names.

<span class="parameter">unfiltered_obj</span> `String`<br>
    If running this on prefiltered data, complete the following steps:
        1. Leave `unfiltered_obj` (this parameter) blank
        2. Rename your filtered file so that it matches the format PARAMS['sample_prefix'] + '.h5mu'
        3. Put the renamed file in the same folder as the `pipeline.yml`
        4. Set `filtering run` to `False` below

<span class="parameter">modalities</span><br>
    Specify which modalities are included in the data by setting the respective modality to True.
    Leave empty (None) or False to signal this modality is not part of the experiment.
    The modalities are processed in the order of the following list:
  - <span class="parameter">rna</span> `Boolean`, Default: True<br>

  - <span class="parameter">prot</span> `Boolean`, Default: False<br>

  - <span class="parameter">rep</span> `Boolean`, Default: False<br>

  - <span class="parameter">atac</span> `Boolean`, Default: False<br>

## Filtering Cells and Features
Filtering in panpipes is done sequentially for all modalities, filtering first cells and then features.
For each modality, the pipeline.yml file contains a dictionary with the following structure:

```yaml
MODALITY:
    obs:
        min:
        max:
        bool:
    var:
        min:
        max:
        bool:
```

This format can be applied to any modality by editing the filtering dictionary  
You are not restricted by the columns given as default.

This is fully customizable to any columns in the mudata.obs or var object.
When specifying a column name, make sure it exactly matches the column name in the h5mu object.

Example:
```yaml
rna:
  obs:
    min:  # Any column for which you want to run a minimum filter
      n_genes_by_counts: 500  # i.e. will filter out cells with a value less than 500 in the n_genes_by_counts column
    max:  # Any column for which you want to run a maximum filter
      pct_counts_mt: 20  # i.e. each cell may have a maximum of 20 in the pct_counts_mt column
                         # be careful with any columns named after gene sets. 
                         # The column will be named based on the gene list input file, 
                         # so if the mitochondrial genes are in group "mt" 
                         # as in the example given in the resource file,
                         # then the column will be named "pct_counts_mt".
    bool: 
       is_doublet: False  # if you have any boolean columns you want to filter on, 
                          # then use this section of the modality dictionary
                          # in this case any obs['is_doublet'] that are False will be retained in the dataset.
```

<span class="parameter">filtering</span><br>
  - <span class="parameter">run</span> `Boolean`, Default: True<br>
    If set to False, no filtering is applied to the `MuData` object.

  - <span class="parameter">keep_barcodes</span> `String` (Path)<br>
    Path to a file containing specific cell barcodes you want to keep; leave blank if not applicable.

  - <span class="parameter">rep</span> `Boolean`, Default: False<br>

### RNA-specific filtering (rna)
<span class="parameter">obs</span><br>
    Parameters for obs, i.e. cell level filtering:

  - <span class="parameter">min</span><br>
    Filtering cells based on a minimum value in a column. Leave parameters blank if you do not want to filter by them.

    - <span class="parameter">n_genes_by_counts</span> `Integer`<br>
      Minimum number of genes by counts per cell.
      For instance, setting the parameter to 500, will filter out cells with a value less than 500 in the n_genes_by_counts column.

  - <span class="parameter">max</span><br>
    Filtering cells based on a maximum value in a column. Leave parameters blank if you do not want to filter by them.
    
    - <span class="parameter">total_counts</span> `Integer`<br>
      Cells with a total count greater than this value will be filtered out.
    
    - <span class="parameter">n_genes_by_counts</span> `Integer`<br>
      Maximum number of genes by counts per cell.

    - <span class="parameter">pct_counts_mt</span> `Integer` (in Percent)<br>
      Percent of counts that are mitochondrial genes. Cells with a value greater than this will be filtered out.
      Should be a value between 0 and 100 (%).
    
    - <span class="parameter">pct_counts_rp</span> `Integer` (in Percent)<br>
      Percent of counts that are ribosomal genes. Cells with a value greater than this will be filtered out.
      Should be a value between 0 and 100 (%).

    - <span class="parameter">doublet_scores</span> `Integer`<br>
      If you want to apply a custom scrublet threshold per input sample you can specify it here.
      Provide either as one score for all samples (e.g. 0.25), or a csv file with two columns sample_id, and cut off.

  - <span class="parameter">bool</span><br>
      You can add a new column to the mudata['rna'].obs with boolean (True/False) values, and then list
      that column under this bool section. This can be done for any modality.

<span class="parameter">var</span><br>
    Parameters for var, i.e. gene (feature) level filtering:

  - <span class="parameter">min</span><br>

    - <span class="parameter">n_cells_by_counts</span> `Integer`<br>

  - <span class="parameter">max</span><br>

    - <span class="parameter">total_counts</span> `Integer`<br>

    - <span class="parameter">n_cells_by_counts</span> `Integer`<br>

### Protein-specific filtering (prot)
<span class="parameter">obs</span><br>
    Parameters for obs, i.e. cell level filtering:

  - <span class="parameter">max</span><br>
    Filtering cells based on a maximum value in a column. Leave parameters blank if you do not want to filter by them.
    
    - <span class="parameter">total_counts</span> `Integer`<br>
      Cells with a total count greater than this value will be filtered out.
    
### ATAC-specific filtering (atac)
<span class="parameter">var</span><br>
    Parameters for var, i.e. gene (feature) level filtering:

  - <span class="parameter">nucleosome_signal</span><br>

## Intersecting cell barcodes
<span class="parameter">intersect_mods</span> `String`<br>
    Taking observations present only in modalities listed in mods, or all modalities if set to None.  
    Provide a comma separated list where you want to keep only the intersection of barcodes. e.g. rna,prot 

## Downsampling cell barcodes
<span class="parameter">downsample_n</span> `Integer`<br>
    Number of cells to downsample to, leave blank to keep all cells.

<span class="parameter">downsample_col</span> `String`<br>
    If you want to equalise by dataset or sample_id, then specifiy a column in obs of the adata to downsample by here.
    If specified, the data will be subset to n cells **per** downsample_col value.

<span class="parameter">downsample_mods</span> `String` (comma separated)<br>
    Specify which modalities you want to subsample.
    If more than one modality is added then these will be intersected.
    Provide as a comma separated String, e.g.: rna,prot


